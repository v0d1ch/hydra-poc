<!doctype html>
<html lang="ja" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/head-protocol/ja/adr/rss.xml" title="Hydra: Head Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/head-protocol/ja/adr/atom.xml" title="Hydra: Head Protocol Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Hydra: Head Protocol" href="/head-protocol/ja/opensearch.xml">
<script src="https://plausible.io/js/script.js" defer="defer" data-domain="hydra.family"></script><title data-rh="true">「Accepted」タグの記事が17件あります | Hydra: Head Protocol</title><meta data-rh="true" property="og:title" content="「Accepted」タグの記事が17件あります | Hydra: Head Protocol"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://input-output-hk.github.io/head-protocol/ja/adr/tags/accepted/page/2"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/head-protocol/ja/img/hydra.png"><link data-rh="true" rel="canonical" href="https://input-output-hk.github.io/head-protocol/ja/adr/tags/accepted/page/2"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/adr/tags/accepted/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/fr/adr/tags/accepted/page/2" hreflang="fr"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/ja/adr/tags/accepted/page/2" hreflang="ja"><link data-rh="true" rel="alternate" href="https://input-output-hk.github.io/head-protocol/adr/tags/accepted/page/2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YZTAF8IOVB-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/head-protocol/ja/assets/css/styles.e05ca3b1.css">
<link rel="preload" href="/head-protocol/ja/assets/js/runtime~main.d4449c1e.js" as="script">
<link rel="preload" href="/head-protocol/ja/assets/js/main.d70fb43e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">メインコンテンツまでスキップ</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/head-protocol/ja/"><div class="navbar__logo"><img src="/head-protocol/ja/img/hydra.png" alt="Hydra: Head Protocol" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/head-protocol/ja/img/hydra-white.png" alt="Hydra: Head Protocol" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Hydra: Head Protocol</b></a><a class="navbar__item navbar__link" href="/head-protocol/ja/docs/getting-started">ユーザーズマニュアル</a><a class="navbar__item navbar__link" href="/head-protocol/ja/use-cases">Use Cases</a><a class="navbar__item navbar__link" href="/head-protocol/ja/core-concepts">コアコンセプト</a><a class="navbar__item navbar__link" href="/head-protocol/ja/topologies">トポロジー</a><a class="navbar__item navbar__link" href="/head-protocol/ja/benchmarks">ベンチマーク</a><a class="navbar__item navbar__link" href="/head-protocol/ja/api-reference">APIリファレンス</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/input-output-hk/hydra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>日本語</span></span></a><ul class="dropdown__menu"><li><a href="/head-protocol/adr/tags/accepted/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/head-protocol/fr/adr/tags/accepted/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link">Français</a></li><li><a href="/head-protocol/ja/adr/tags/accepted/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">日本語</a></li></ul></div><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently ライトモード)"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="検索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">検索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Architectural Decision Records</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/1">1. Record Architecture Decisions
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/2">2. Reactive Core
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/3">3. Asynchronous Duplex Client API</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/4">4. Use Handle to model Effects
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/5">5. Use io-classes
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/6">6. Network Broadcasts all messages
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/7">7. Use with-pattern based component interfaces
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/8">8. Custom Prelude
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/9">9. Simplify Logging
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/10">10. Use Direct Connection to `cardano-node`
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/11">11. Use cardano-api
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/12">12. Top-down Test-driven Design
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/13">13. Plutus Contracts Testing Strategy
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/14">14. Token usage in Hydra Scripts
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/15">15. Configuration Through an Admin API
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/16">16. Keep Rejected ADRs
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/17">17. Use UDP protocol for Hydra networking
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/18">18. Single state in Hydra.Node.
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/19">19. Use of reference scripts
</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/head-protocol/ja/adr/20">20. Handling time
</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>「Accepted」タグの記事が17件あります</h1><a href="/head-protocol/ja/adr/tags">全てのタグを見る</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/11">11. Use cardano-api
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-11-18T00:00:00.000Z" itemprop="datePublished">2021年11月18日</time> · <!-- -->約2分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><ul><li>To implement Hydra Head&#x27;s ledger we have been working with the <a href="https://github.com/input-output-hk/cardano-ledger-specs" target="_blank" rel="noopener noreferrer">ledger-specs</a> packages which provide a low-level interface to work with transactions and ledgers<ul><li>We also use a lightly wrapped ledger-specs API as our interface for Off-chain transaction submission. This introduced some boilerplate in order to align with cardano-api and provide JSON serialisation.</li></ul></li><li>In our initial experiments <a href="/head-protocol/ja/adr/10">connecting directly</a> to a cardano node we have also been using the ledger API for building transactions for want of some scripts-related features in the cardano-api</li><li>cardano-api is expected to be the supported entrypoint for clients to interact with Cardano chain while ledger-specs is reserved for internal use and direct interactions with ledgers</li><li>cardano-api now provides all the features we need to run our on-chain validators</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><p><em>Therefore</em></p><ul><li>Use cardano-api types and functions instead of ledger-specs in <code>Hydra.Chain.Direct</code> component</li><li>Use cardano-api types instead of custom ones in <code>Hydra.Ledger.Cardano</code> component</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><ul><li>Removes the boilerplate in <code>Hydra.Ledger.Cardano</code> required to map cardano-api types sent by clients to builtin and ledger-specs types</li><li>Simplifies the  <code>Hydra.Chain.Direct</code> component:<ul><li>Replaces custom transaction building in <code>Tx</code></li><li>Replaces custom transaction fees calculation and balancing in <code>Wallet</code></li><li>Replace low-level connection establishment using cardano-api functions connecting to the node (keeping the chain sync subscription)</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="11. Use cardano-api
の続きを読む" href="/head-protocol/ja/adr/11"><b>もっと見る</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/12">12. Top-down Test-driven Design
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-11-25T00:00:00.000Z" itemprop="datePublished">2021年11月25日</time> · <!-- -->約2分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><ul><li><a href="https://en.wikipedia.org/wiki/Test-driven_development" target="_blank" rel="noopener noreferrer">Test-Driven Development</a> or <em>Test-Driven Design</em> is a technique that helps team promotes simple and loosely coupled design, reduces the amount of code written, increases confidence in delivered software by providing a high level of code coverage by regression tests, and improves development speed through shorter feedback loop</li><li>While initially focused on <em>unit tests</em>, TDD has evolved over time to include higher-level tests like <a href="https://en.wikipedia.org/wiki/Behavior-driven_development" target="_blank" rel="noopener noreferrer">Behaviour Driven Development</a> or <a href="https://en.wikipedia.org/wiki/Specification_by_example" target="_blank" rel="noopener noreferrer">Specification by Example</a>, leading to comprehensive strategies like the <a href="http://tpierrain.blogspot.com/2021/03/outside-in-diamond-tdd-1-style-made.html" target="_blank" rel="noopener noreferrer">Outside-In Diamond TDD</a></li><li>Being a foundational part of scalable applications based on Cardano blockchain, Hydra Head needs to be released early, often, and with high assurance in order to benefit from early adopters&#x27; feedback</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><p><em>Therefore</em></p><p>We start as early as possible with <em>End-to-End</em> tests, gradually making them more complex as we develop the various components but starting with something simple (like a system-level but dummy chain and hydra network).</p><p>We flesh out other integration tests as needed, when we refine the technological stack used for the various bits and pieces.</p><p>We do most of our work in the <em>Executable Specifications</em> layer while we are developing the core domain functions, eg. the Head protocol. The rationale being this is the level at which we can test the most complex behaviours in the fastest and safest possible way as we everything runs without external dependencies or can even run as pure code using io-sim.</p><p>We tactically drop to <em>Unit tests</em> level when dealing with the protocol&#x27;s &quot;fine prints&quot;.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><ul><li>Development of each &quot;feature&quot;, whether new or change to existing one, should start with a test defined at the highest level possible, but no higher</li><li>A detailed presentation of the various testing layers is available in the <a href="https://github.com/input-output-hk/hydra/wiki/Testing-Strategy" target="_blank" rel="noopener noreferrer">wiki</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="12. Top-down Test-driven Design
の続きを読む" href="/head-protocol/ja/adr/12"><b>もっと見る</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/13">13. Plutus Contracts Testing Strategy
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-01-19T00:00:00.000Z" itemprop="datePublished">2022年1月19日</time> · <!-- -->約2分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><ul><li>We are implementing our custom (<a href="/head-protocol/ja/adr/10">Direct</a>) interaction w/ Cardano blockchain and not using the PAB nor the <code>Contract</code> monad to define off-chain contract code</li><li>This implies we cannot use the <a href="https://github.com/input-output-hk/plutus-apps/blob/main/plutus-contract/src/Plutus/Contract/Test.hs" target="_blank" rel="noopener noreferrer">official</a> testing framework for Contracts which relies on <code>Contract</code> monad and emulator traces nor the <a href="https://plutus-apps.readthedocs.io/en/latest/plutus/tutorials/contract-testing.html" target="_blank" rel="noopener noreferrer">QuickCheck based framework</a></li><li>We want to follow our <a href="/head-protocol/ja/adr/12">Test-Driven Development</a> approach for contracts as this is a critical part of Hydra</li><li>On-Chain Validators need not only to be correct and functional, but also secure and hardened against malicious parties</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><p><em>Therefore</em></p><ul><li>We test-drive single contracts code using <em>Mutation-Based Property Testing</em></li><li>Contracts are tested through the construction of actual <em>transactions</em> and running phase-2 ledger validation process</li><li>We start from a &quot;healthy&quot; transaction, that&#x27;s expected to be correct and stay so</li><li>Contract code is initially <code>const True</code> function that validates any transaction</li><li>We flesh the contract&#x27;s code piecemeal through the introduction of <em>Mutations</em> that turn a healthy transaction into an expectedly invalid one</li><li>We gradually build a set of combinators and generators that make it easier to mutate arbitrarily transactions, and combine those mutations</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><ul><li>We make the contracts&#x27; <em>Threat model</em>  explicit through the tests we write, which should help future auditors&#x27; work</li><li>We&#x27;ll need an additional layer of tests to exercise the Hydra OCV State Machine through <em>sequence of transactions</em>. This could be implemented using <a href="https://github.com/input-output-hk/plutus-apps/tree/main/quickcheck-dynamic" target="_blank" rel="noopener noreferrer">quickcheck-dynamic</a> library, or other tools that are currently being developed by the Cardano community</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="13. Plutus Contracts Testing Strategy
の続きを読む" href="/head-protocol/ja/adr/13"><b>もっと見る</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/14">14. Token usage in Hydra Scripts
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-14T00:00:00.000Z" itemprop="datePublished">2022年2月14日</time> · <!-- -->約3分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><ul><li>The Hydra on-chain-verification scripts are used to validate Hydra protocol transactions and ensure they are lawful.</li><li>At least these three properties need to be enforced:<ul><li>Authentication: ensure that only Head participants can, for example, <code>abort</code> a Head</li><li>Contract continuity: ensure that a Head was <code>init</code>ialized before it can be opened by a <code>collectCom</code> tx.</li><li>Completeness: ensure that all Head participants had chance to <code>commit</code> funds to a Head.</li></ul></li><li>The Hydra Head paper introduces <strong>participation tokens (PT)</strong> and a <strong>state thread token (ST)</strong> for that matter.</li><li>Such tokens (a.k.a native assets) are identified by the <code>CurrencySymbol</code>, that is the hash of their <code>MintingPolicyScript</code> (a.k.a <code>PolicyID</code> in the ledger), and a <code>ByteString</code>, the socalled <code>TokenName</code> (a.k.a as <code>AssetName</code> in the ledger, see <a href="https://hydra.iohk.io/job/Cardano/cardano-ledger-specs/specs.shelley-ma/latest/download-by-type/doc-pdf/shelley-ma#subsection.3.2" target="_blank" rel="noopener noreferrer">shelley-ma ledger spec</a>)</li><li>There can be multiple Hydra Heads on a network and a <code>hydra-node</code> need to distinguish individual Head instances or even (later) keep track of multiple Heads. Concretely, this means that we need to infer a Head identifier (<code>HeadId</code>) from observing each of the Hydra protocol transactions. </li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><ul><li>We solve both challenges by defining that ST and PTs <strong>shall use the same</strong> <code>MintingPolicyScript</code> and thus have same <code>CurrencySymbol</code></li><li>The <code>MintingPolicyScript</code> shall be parameterized by <code>TxOutRef</code> to yield a unique <code>CurrencySymbol</code> per Head
(similar to the <a href="https://github.com/input-output-hk/plutus/tree/1efbb276ef1a10ca6961d0fd32e6141e9798bd11/plutus-use-cases/src/Plutus/Contracts/Currency.hs" target="_blank" rel="noopener noreferrer"><code>OneShotCurrency</code></a> example)</li><li>ST and one PT per participant are minted in the <code>initTx</code></li><li>The <code>TokenName</code> of the ST can be any well-known <code>ByteString</code>, e.g. <code>&quot;HydraHeadV1&quot;</code></li><li>The <code>TokenName</code> of the PTs needs to be the <code>PubKeyHash</code> of the respective participant</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><ul><li><p>Heads can be identified by looking for the <code>ST</code> in <code>init</code>, <code>collectCom</code>, <code>close</code>, <code>contest</code> or <code>fanout</code> transactions, or the <code>PT</code> in <code>commit</code> transactions. In both cases, the <code>CurrencySymbol == HeadId</code></p></li><li><p>Our scripts become simpler as we only need to check that ST/PT are paid forward, instead of needing to check datums</p></li><li><p>The datum produced by <code>commit</code> txs (and consumed by <code>collectCom</code>) is <code>Just SerializedTxOut</code>, which is simpler than also keeping the participant which committed in the datum (compare to full life-cycle of <a href="https://github.com/input-output-hk/hydra/tree/0.3.0/docs/images/on-chain-full.jpg" target="_blank" rel="noopener noreferrer">0.3.0</a>).</p></li><li><p>The <code>v_head</code> script validator does not need to be parameterized, which makes discovering new Heads (and also tracking them for metrics) easier as the address to watch for is common to all Heads (of the same <code>v_head</code> version).</p></li><li><p>The <code>v_head</code> script (path) for the abort life-cycle can be implemented already much safer by checking that all PTs are burned on the <code>abort</code> transaction (counting inputs in abort life-cycle of <a href="https://github.com/input-output-hk/hydra/tree/0.3.0/docs/images/on-chain-abort.jpg" target="_blank" rel="noopener noreferrer">0.3.0</a>).</p></li><li><p>Updated diagrams for the <a target="_blank" href="/head-protocol/ja/assets/files/on-chain-full-eea3dda97376810a7bfac1848a11a84a.jpg">full</a> and <a target="_blank" href="/head-protocol/ja/assets/files/on-chain-abort-c3483946d3116662c5cabfd67e3dde4e.jpg">abort</a> on-chain life-cycles of a Hydra Head.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="follow-up-questions">Follow-up questions<a class="hash-link" href="#follow-up-questions" title="見出しへの直接リンク">​</a></h2><ul><li>What value does the <code>ST</code> actually add? We could always look for the <code>PT</code> to identify a Head and contract continuity would already be achieved by the <code>PT</code>s!</li><li>In discussions it turned out to be not clear where the Head&#x27;s <code>CurrencySymbol</code> is coming from, and consequently how to identify that an <code>ST</code> is indeed an <code>ST</code>?</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="14. Token usage in Hydra Scripts
の続きを読む" href="/head-protocol/ja/adr/14"><b>もっと見る</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/16">16. Keep Rejected ADRs
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-23T00:00:00.000Z" itemprop="datePublished">2022年3月23日</time> · <!-- -->約1分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><p>We have started using <em>Architecture Decision Records</em> as our primary way to document the most important design decisions we take while developing Hydra Node, and this has proved effective in fostering fruitful discussions about major architecture changes.</p><p>During the course of this project, we have sometimes had debates on various topics leading to rejection of <a href="https://github.com/input-output-hk/hydra/pull/230" target="_blank" rel="noopener noreferrer">some ADRs</a>. It could be the case that  a previously rejected proposal turns out to be interesting, either because the context and situation have changed enough to reevaluate a proposal, or as background for some new proposal.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><p><em>therefore</em></p><ul><li>We will keep rejected <em>Architecture Decision Records</em> alongside accepted and draft ones, in the same location and format</li><li>Rejected ADRs <em>must</em> have tag <code>[Rejected]</code> set</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><p>Once attributed a <em>serial number</em> an ADR keeps it &quot;forever&quot;, whether it&#x27;s rejected or accepted</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="16. Keep Rejected ADRs
の続きを読む" href="/head-protocol/ja/adr/16"><b>もっと見る</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/18">18. Single state in Hydra.Node.
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-13T00:00:00.000Z" itemprop="datePublished">2022年4月13日</time> · <!-- -->約4分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><ul><li>Currently the <code>hydra-node</code> maintains two pieces of state during the life-cycle of a Hydra Head:<ol><li>A <code>HeadState tx</code> provided by the <code>HydraHead tx m</code> handle interface and part of the <code>Hydra.Node</code> module. It provides the basis for the main <code>hydra-node</code> business logic in <code>Hydra.Node.processNextEvent</code> and <code>Hydra.HeadLogic.update</code><a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Node.hs#L256-L257" target="_blank" rel="noopener noreferrer">Creation</a>, <a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Node.hs#L174" target="_blank" rel="noopener noreferrer">Usage</a></li><li><code>SomeOnChainHeadState</code> is kept in the <code>Hydra.Chain.Direct</code> to keep track of the latest known head state, including notable transaction outputs and information how to spend it (e.g. scripts and datums)
<a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Chain/Direct.hs#L156-L162" target="_blank" rel="noopener noreferrer">Code</a>, <a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Chain/Direct.hs#L449" target="_blank" rel="noopener noreferrer">Usage 1</a>, <a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Chain/Direct.hs#L414" target="_blank" rel="noopener noreferrer">Usage 2</a>, <a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Chain/Direct.hs#L349-L352" target="_blank" rel="noopener noreferrer">Usage 3</a>
(There are other unrelated things kept in memory like the event history in the API server or a peer map in the network heartbeat component.)</li></ol></li><li>The interface between the <code>Hydra.Node</code> and a <code>Hydra.Chain</code> component consists of <ul><li>constructing certain Head protocol transactions given a description of it (<code>PostChainTx tx</code>):<div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">postTx :: MonadThrow m =&gt; PostChainTx tx -&gt; m ()</span><br></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_wuS7 clean-btn">コピー</button></div></div></li><li>a callback function when the <code>Hydra.Chain</code> component observed a new Head protocol transaction described by <code>OnChainTx tx</code>:<div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">type ChainCallback tx m = OnChainTx tx -&gt; m ()</span><br></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_wuS7 clean-btn">コピー</button></div></div></li></ul></li><li>Given by the usage sites above, the <code>Hydra.Chain.Direct</code> module requires additional info to do both, construct protocol transactions with <code>postTx</code> as well as observe potential <code>OnChainTx</code> (<a href="https://github.com/input-output-hk/hydra/blob/a98e2907c4e425de2736782793383aad63132c14/hydra-node/src/Hydra/Chain/Direct.hs#L333-L336" target="_blank" rel="noopener noreferrer">here</a>). Hence we see that, operation of the <code>Hydra.Chain.Direct</code> component (and likely any implementing the interface fully) is <strong>inherently stateful</strong>.</li><li>We are looking at upcoming features to <a href="https://github.com/input-output-hk/hydra/issues/185" target="_blank" rel="noopener noreferrer">handle rollbacks</a> and dealing with <a href="https://github.com/input-output-hk/hydra/issues/187" target="_blank" rel="noopener noreferrer">persisting the head state</a>.<ul><li>Both could benefit from the idea, that the <code>HeadState</code> is just a result of pure <code>Event</code> processing (a.k.a event sourcing).</li><li>Right now the <code>HeadState</code> kept in <code>Hydra.Node</code> alone, is not enough to fully describe the state of the <code>hydra-node</code>. Hence it would not be enough to just persist all the <code>Event</code>s and replaying them to achieve persistence, nor resetting to some previous <code>HeadState</code> in the presence of a rollback.</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><ul><li><p>We define and keep a &quot;blackbox&quot; <code>ChainStateType tx</code> in the <code>HeadState tx</code></p><ul><li>It shall not be introspectable to the business logic in <code>HeadLogic</code></li><li>It shall contain chain-specific information about the current Hydra Head, which will naturally need to evolve once we have multiple Heads in our feature scope</li><li>For example:</li></ul><div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data HeadState tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = IdleState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | InitialState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      { chainState :: ChainStateType tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | OpenState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      { chainState :: ChainStateType tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | ClosedState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      { chainState :: ChainStateType tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      -- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_wuS7 clean-btn">コピー</button></div></div></li><li><p>We provide the latest <code>ChainStateType tx</code> to <code>postTx</code>:</p><div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">postTx :: ChainStateType tx -&gt; PostChainTx tx -&gt; m ()</span><br></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_wuS7 clean-btn">コピー</button></div></div></li><li><p>We change the <code>ChainEvent tx</code> data type and callback interface of <code>Chain</code> to:</p><div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">data ChainEvent tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  = Observation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      { observedTx :: OnChainTx tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      , newChainState :: ChainStateType tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | Rollback ChainSlot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | Tick UTCTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ChainCallback tx m = (ChainStateType tx -&gt; Maybe (ChainEvent tx)) -&gt; m ()</span><br></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_wuS7 clean-btn">コピー</button></div></div><p>with the meaning, that invocation of the callback indicates receival of a transaction which is <code>Maybe</code> observing a relevant <code>ChainEvent tx</code>, where an <code>Observation</code> may include a <code>newChainState</code>.</p></li><li><p>We also decide to extend <code>OnChainEffect</code> with a <code>ChainState tx</code> to explicitly
thread the used <code>chainState</code> in the <code>Hydra.HeadLogic</code>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><ul><li>We need to change the construction of <code>Chain</code> handles and the call sites of <code>postTx</code></li><li>We need to extract the state handling (similar to the event queue) out of the <code>HydraNode</code> handle and shuffle the main of <code>hydra-node</code> a bit to be able to provide the latest <code>ChainState</code> to the chain callback as a continuation.</li><li>We need to make the <code>ChainState</code> serializable (<code>ToJSON</code>, <code>FromJSON</code>) as it will be part of the <code>HeadState</code>.</li><li>We can drop the <code>TVar</code> of keeping <code>OnChainHeadState</code> in the <code>Hydra.Chain.Direct</code> module.</li><li>We need to update <code>DirectChainSpec</code> and <code>BehaviorSpec</code> test suites to mock/implement the callback &amp; state handling.</li><li>We might be able to simplify the <code>ChainState tx</code> to be just a <code>UTxOType tx</code> later.</li><li>As <code>OnChainEffect</code> and <code>Observation</code> values will contain a <code>ChainStateType tx</code>, traces will automatically include the full <code>ChainState</code>, which might be helpful but also possible big. </li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="alternative">Alternative<a class="hash-link" href="#alternative" title="見出しへの直接リンク">​</a></h2><ul><li>We could extend <code>PostChainTx</code> (like <code>Observation</code>) with <code>ChainState</code> and keep the signatures:</li></ul><div class="codeBlockContainer_I0IT language-hs theme-code-block"><div class="codeBlockContent_wNvx hs"><pre tabindex="0" class="prism-code language-hs codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">postTx :: MonadThrow m =&gt; PostChainTx tx -&gt; m ()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ChainCallback tx m = (ChainState tx -&gt; Maybe (ChainEvent tx) -&gt; m ()</span><br></span></code></pre><button type="button" aria-label="クリップボードにコードをコピー" class="copyButton_wuS7 clean-btn">コピー</button></div></div><ul><li>Not implemented as it is less clear on the need for a <code>ChainState</code> in the signatures.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="18. Single state in Hydra.Node.
の続きを読む" href="/head-protocol/ja/adr/18"><b>もっと見る</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/head-protocol/ja/adr/20">20. Handling time
</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-08-02T00:00:00.000Z" itemprop="datePublished">2022年8月2日</time> · <!-- -->約4分</div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="status">Status<a class="hash-link" href="#status" title="見出しへの直接リンク">​</a></h2><p>Accepted</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="context">Context<a class="hash-link" href="#context" title="見出しへの直接リンク">​</a></h2><ul><li><p>The Hydra Head protocol is expected to be isomorphic to the ledger it runs on. That means, it should support the same transaction formats and (if desired) use the same ledger rules as the layer 1.</p></li><li><p>Cardano is our layer 1 and its consensus layer separates time into discrete steps, where each step is called a <code>Slot</code>. The network is expected to evolve strictly monotonically on this time scale and so slot numbers (<code>SlotNo</code>) are always increasing.</p></li><li><p>The Cardano mainnet has a block scheduled every 20 seconds, although it may take longer.</p><ul><li>This is because <code>slotLength = 1.0</code> and every 20th slot is &quot;active&quot; with <code>f = 0.05</code>.</li><li>The consensus protocol requires <code>k</code> blocks to be produced within <code>3k/f</code> slots, where <code>k = 2160</code> on mainnet.</li></ul></li><li><p>Transactions on Cardano may have a validity range with a lower and upper bound given as <code>SlotNo</code>.</p></li><li><p>Wall-clock time can be converted to slots (and back) using an <code>EraHistory</code> or <code>EpochInterpreter</code> provided by the consensus layer of the cardano node. This is required as the slot lengths could change over time.</p><ul><li>All past points in time since the <code>SystemStart</code> can be converted.</li><li>Future points in time can <strong>only</strong> be converted in the &quot;safe zone&quot;, practically being at least <code>3k/f</code> slots (TODO: cross check). Refer to chapter 17 <em>Time</em> on the <a href="https://hydra.iohk.io/build/16997794/download/1/report.pdf" target="_blank" rel="noopener noreferrer">consensus spec</a> for more details.</li></ul></li><li><p>The Hydra Head protocol allows <code>close</code> and <code>contest</code> transactions only up before a deadline <code>T_final</code>, and <code>fanout</code> transactions after the deadline.</p><ul><li>In the current implementation the deadline is upper validity of <code>closed</code> plus the contestation period.</li><li>We also consider protocol variants which push out the deadline by the contestation period on each <code>contest</code>.</li><li>Contestation periods may very well be longer than the stability window of the protocol. For example: 7 days, while the mainnet stability window is more like 36 hours.</li></ul></li><li><p>We have encountered two problems with handling time in the past</p><ul><li>Trying to convert wall-clock time to slots of the Head protocol deadline led to <code>PastHorizonException</code> (when using very low security parameter <code>k</code>)</li><li>Trying to <code>fanout</code> after the deadline, but before another block has been seen by the L1 ledger led to <code>OutsideValidityIntervalUTxO</code>.</li></ul></li><li><p>The second problem scenario and solution ideas are roughly visible on this whiteboard:</p></li></ul><p><img loading="lazy" src="/head-protocol/ja/assets/images/020-timing-fanout-ab1b5156cfc3fa34b570aa3eec42d0dd.jpg" width="1005" height="1067"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="decision">Decision<a class="hash-link" href="#decision" title="見出しへの直接リンク">​</a></h2><ul><li><p>The head logic uses wall-clock time to track time and only convert to/from slots when constructing/observing transactions in the chain layer.</p><ul><li>This ensures that transactions we post or see on the chain can be converted to/from slots.</li><li>The head logic would use <code>UTCTime</code> for points in time and <code>NominalDiffTime</code> for durations.</li><li>The chain layer converts these using the <code>SystemStart</code> and <code>EraHistory</code> into <code>SlotNo</code>.</li></ul></li><li><p>The chain layer informs the logic layer whenever time passed (on the chain) using a new <code>Tick</code> event.</p><ul><li>For the direct chain implementation, this is whenever we see a block in the chain sync protocol.</li><li>Per above decision, the <code>Tick</code> shall contain a <code>UTCTime</code> corresponding to the new &quot;now&quot; as seen through the block chain.</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="consequences">Consequences<a class="hash-link" href="#consequences" title="見出しへの直接リンク">​</a></h2><ul><li><p>Conversion from <code>UTCTime -&gt; SlotNo</code> and vice versa stays local to the chain layer.</p></li><li><p>The <code>HeadLogic</code> can track chain time in its state and condition <code>ReadyToFanout</code> upon seeing it pass the deadline.</p><ul><li>Ensures clients only see <code>ReadyToFanout</code> when a following <code>Fanout</code> would be really possible.</li><li>Makes the <code>Delay</code> effect redundant and we can remove it (only delay via reenqueue on the <code>Wait</code> outcome)</li></ul></li><li><p>By introducing <code>Tick</code> events, <code>IOSim</code> will not be able to detect non-progress (deadlocks).</p><ul><li>This means we cannot rely on early exit of simulations anymore and need to determine meaningful simulation endings instead of <code>waitUntilTheEndOfTime</code>.</li></ul></li><li><p>We get a first, rough notion of time for free in our L2 and can support &quot;timed transactions&quot; with same resolution as the L1.</p><ul><li>Tracking time in the state makes it trivial to provide it to the ledger when we <code>applyTransaction</code>.</li><li>Of course we could extend the fidelity of this feature using the system clock for &quot;dead reckoning&quot; between blocks. The conversion of wall clock to slot could even be configurable using an L2 <code>slotLength</code> analogous to L1 (although we might not want/need this).</li></ul></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>タグ:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/head-protocol/ja/adr/tags/accepted">Accepted</a></li></ul></div><div class="col text--right col--3"><a aria-label="20. Handling time
の続きを読む" href="/head-protocol/ja/adr/20"><b>もっと見る</b></a></div></footer></article><nav class="pagination-nav" aria-label="ブログ記事一覧のナビゲーション"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/head-protocol/ja/adr/tags/accepted"><div class="pagination-nav__label">新しい記事</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">貢献</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Coding-Standards" target="_blank" rel="noopener noreferrer" class="footer__link-item">コーディング規約</a></li><li class="footer__item"><a class="footer__link-item" href="/head-protocol/ja/adr">アーキテクチャデシジョンレコード</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Testing-Strategy" target="_blank" rel="noopener noreferrer" class="footer__link-item">テスト戦略</a></li></ul></div><div class="col footer__col"><div class="footer__title">コミュニティ</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/Qq5vNTg9PT" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord (#ask-hydra)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Githubディスカッション<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://cardano.stackexchange.com/questions/tagged/hydra" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Exchange<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">その他</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/head-protocol/ja/docs/haskell_packages">Haskellパッケージ</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/wiki/Logbook" target="_blank" rel="noopener noreferrer" class="footer__link-item">Logbook</a></li><li class="footer__item"><a href="https://iohk.io/en/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">Input Output (ブログ)</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://static.iohk.io/terms/iohktermsandconditions.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms &amp; Conditions</a></li><li class="footer__item"><a href="https://static.iohk.io/terms/iog-privacy-policy.pdf" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://github.com/input-output-hk/hydra/graphs/contributors" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contributors</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 <strong>Input Output</strong> <br> <small>Built with Docusaurus</small></div></div></div></footer></div>
<script src="/head-protocol/ja/assets/js/runtime~main.d4449c1e.js"></script>
<script src="/head-protocol/ja/assets/js/main.d70fb43e.js"></script>
</body>
</html>